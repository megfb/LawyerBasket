<div class="posts-list-container">
  <div class="posts-list-header">
    <p-button
      label="Geri"
      icon="pi pi-arrow-left"
      [outlined]="true"
      [text]="true"
      (onClick)="goBack()"
      class="back-button"
    ></p-button>
    <h1 class="page-title">Gönderilerim</h1>
    <button 
      class="new-post-button"
      (click)="onShowCreatePostModal()"
      title="Yeni Gönderi"
    >
      <span class="material-symbols-outlined">add</span>
    </button>
  </div>

  <p-card class="posts-list-card">
    @if (isLoadingPosts) {
      <div class="loading-container">
        <p-progressSpinner></p-progressSpinner>
        <p>Gönderiler yükleniyor...</p>
      </div>
    } @else if (postsError) {
      <div class="error-container">
        <p class="error-message">{{ postsError }}</p>
      </div>
    } @else if (posts.length === 0) {
      <div class="empty-container">
        <p class="empty-message">Henüz gönderi yok.</p>
      </div>
    } @else {
      <div class="posts-list">
        @for (post of posts; track post.id) {
          <div class="post-item">
            <span 
              class="material-symbols-outlined post-delete-icon"
              (click)="onDeletePost($event, post)"
              title="Sil"
            >delete</span>
            <div class="post-content">
              <p class="post-text">{{ post.content }}</p>
              <div class="post-meta">
                <span class="post-date">{{ formatDate(post.createdAt) }}</span>
              </div>
            </div>
            <div class="post-stats">
              <div class="stat-item">
                <span class="material-symbols-outlined stat-icon">favorite</span>
                <span class="stat-count">{{ getLikesCount(post) }}</span>
              </div>
              <div class="stat-item stat-item-clickable" (click)="onToggleComments($event, post)">
                <span class="material-symbols-outlined stat-icon">comment</span>
                <span class="stat-count">{{ getCommentsCount(post) }}</span>
              </div>
            </div>
            @if (isCommentsExpanded(post)) {
              <div class="comments-section">
                <div class="comment-form-container">
                  <form [formGroup]="getCommentForm(post.id)" (ngSubmit)="onSubmitComment(post)">
                    <div class="comment-input-wrapper">
                      <textarea
                        pInputTextarea
                        formControlName="text"
                        placeholder="Yorum yazın..."
                        rows="2"
                        [style]="{ width: '100%', resize: 'vertical' }"
                        [class.ng-invalid]="getCommentForm(post.id).get('text')?.invalid && (getCommentForm(post.id).get('text')?.dirty || getCommentForm(post.id).get('text')?.touched)"
                      ></textarea>
                      <p-button
                        label="Yorum Yap"
                        icon="pi pi-send"
                        type="submit"
                        [loading]="isSubmittingCommentForPost(post.id)"
                        [disabled]="isSubmittingCommentForPost(post.id) || getCommentForm(post.id).invalid"
                        [style]="{ 'margin-top': '8px' }"
                      ></p-button>
                    </div>
                    @if (getCommentForm(post.id).get('text')?.invalid && (getCommentForm(post.id).get('text')?.dirty || getCommentForm(post.id).get('text')?.touched)) {
                      <small class="error-text">
                        @if (getCommentForm(post.id).get('text')?.hasError('required')) {
                          Bu alan zorunludur.
                        } @else if (getCommentForm(post.id).get('text')?.hasError('maxlength')) {
                          Maksimum 255 karakter olmalıdır.
                        }
                      </small>
                    }
                  </form>
                </div>
                @if (getComments(post).length === 0) {
                  <p class="empty-comments-message">Henüz yorum yok.</p>
                } @else {
                  <div class="comments-list">
                    @for (comment of getComments(post); track comment.id) {
                      <div class="comment-item">
                        <span 
                          class="material-symbols-outlined comment-delete-icon"
                          (click)="onDeleteComment($event, post, comment)"
                          title="Sil"
                        >delete</span>
                        <div class="comment-header">
                          <span class="comment-user-id">Kullanıcı ID: {{ comment.userId }}</span>
                          <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                        </div>
                        <p class="comment-text">{{ comment.text }}</p>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </p-card>
  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>

  <p-dialog
    [(visible)]="showCreatePostModal"
    [modal]="true"
    [style]="{ width: '600px' }"
    [header]="'Yeni Gönderi'"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
  >
    <form [formGroup]="createPostForm" (ngSubmit)="onCreatePost()">
      <div class="create-post-form">
        <div class="form-field">
          <label for="content">Gönderi İçeriği *</label>
          <textarea
            id="content"
            pInputTextarea
            formControlName="content"
            placeholder="Ne düşünüyorsunuz?"
            rows="6"
            [style]="{ width: '100%', resize: 'vertical' }"
            [class.ng-invalid]="createPostForm.get('content')?.invalid && (createPostForm.get('content')?.dirty || createPostForm.get('content')?.touched)"
          ></textarea>
          @if (createPostForm.get('content')?.invalid && (createPostForm.get('content')?.dirty || createPostForm.get('content')?.touched)) {
            <small class="error-text">
              @if (createPostForm.get('content')?.hasError('required')) {
                Bu alan zorunludur.
              } @else if (createPostForm.get('content')?.hasError('maxlength')) {
                Maksimum 255 karakter olmalıdır.
              }
            </small>
          }
        </div>
      </div>
      <div class="create-post-actions">
        <p-button
          label="İptal"
          icon="pi pi-times"
          [outlined]="true"
          type="button"
          (onClick)="onCloseCreatePostModal()"
          [disabled]="isSubmittingPost"
        ></p-button>
        <p-button
          label="Paylaş"
          icon="pi pi-send"
          type="submit"
          [loading]="isSubmittingPost"
          [disabled]="isSubmittingPost || createPostForm.invalid"
        ></p-button>
      </div>
    </form>
  </p-dialog>
</div>

